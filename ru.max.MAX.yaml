app-id: ru.max.MAX
runtime: org.kde.Platform
runtime-version: '6.9'
sdk: org.kde.Sdk
base: io.qt.qtwebengine.BaseApp
base-version: '6.9'
command: max
separate-locales: false
tags:
  - proprietary
finish-args:
  - --device=all
  - --share=ipc
  - --share=network
  - --socket=pulseaudio
  - --socket=x11 # MAX does not support wayland or fallback-x11
  - --env=QTWEBENGINEPROCESS_PATH=/app/bin/QtWebEngineProcess
  - --talk-name=org.kde.StatusNotifierWatcher
  - --filesystem=xdg-run/pipewire-0:ro
  - --filesystem=xdg-download
cleanup:
    - /include
    - /lib/cmake
    - /lib/*/cmake
    - /lib/pkgconfig
    - /mkspecs
    - /share/doc
    - /share/man
    - '*.la'
    - '*.a'
cleanup-commands:
    - /app/cleanup-BaseApp.sh
modules:
  - name: xorg-font-util
    buildsystem: autotools
    sources:
      - type: git
        url: https://gitlab.freedesktop.org/xorg/font/util.git
        commit: b5ca142f81a6f14eddb23be050291d1c25514777
        tag: font-util-1.4.1
        x-checker-data:
          type: anitya
          project-id: 15055
          tag-template: font-util-$version
  - name: libfontenc
    buildsystem: autotools
    sources:
      - type: git
        url: https://gitlab.freedesktop.org/xorg/lib/libfontenc.git
        commit: 780d1f6f192a331de7b298a96e23ebc44d2a884b
        tag: libfontenc-1.1.9
        x-checker-data:
          type: anitya
          project-id: 1613
          tag-template: libfontenc-$version
  - name: libXmu
    buildsystem: autotools
    sources:
      - type: git
        url: https://gitlab.freedesktop.org/xorg/lib/libxmu.git
        commit: cdf280f6611932f79ab872832974e8043b1cad6d
        tag: libXmu-1.3.1
        x-checker-data:
          type: anitya
          project-id: 1785
          tag-template: libXmu-$version
  - name: libXaw
    buildsystem: autotools
    sources:
      - type: git
        url: https://gitlab.freedesktop.org/xorg/lib/libxaw.git
        commit: f14ba54e9c7e415a05e33dd0b3b5f96e5de05c8b
        tag: libXaw-1.0.16
        x-checker-data:
          type: anitya
          project-id: 1766
          tag-template: libXaw-$version
  - name: libXRes
    buildsystem: autotools
    sources:
      - type: git
        url: https://gitlab.freedesktop.org/xorg/lib/libxres.git
        commit: 30c789e5065f7af7d6a03c09e3ceb073ed810bdd
        tag: libXres-1.2.3
        x-checker-data:
          type: anitya
          project-id: 1790
          tag-template: libXres-$version
  - name: max
    buildsystem: simple
    build-commands:
      - install -Dm 755 max.sh ${FLATPAK_DEST}/bin/max
      - install -Dm 755 apply_extra.sh ${FLATPAK_DEST}/bin/apply_extra
      - install -Dm 644 ${FLATPAK_ID}.metainfo.xml ${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml
      - install -Dm 644 MAX.png ${FLATPAK_DEST}/share/icons/hicolor/512x512/apps/${FLATPAK_ID}.png
      - install -Dm 644 ${FLATPAK_ID}.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
    sources:
      - type: extra-data
        filename: MAX.deb
        url: https://download.max.ru/linux/deb/pool/main/m/max/MAX-26.4.1.46437.deb
        sha256: a4a1ceb267cdec72de4258a20a2ac9719e41ae42b096f8a898ee425c8e9dc6f0
        size: 294878896
        x-checker-data:
          type: debian-repo
          package-name: max
          root: https://download.max.ru/linux/deb
          dist: stable
          component: main
          is-main-source: true
      - type: script
        dest-filename: apply_extra.sh
        commands:
          - bsdtar -Oxf MAX.deb data.tar.xz | bsdtar -xf - --strip-components=3 ./usr/share/max
          - rm MAX.deb
      - type: script
        dest-filename: max.sh
        commands:
          - export LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:/app/share/max/lib64:/app/share/max/lib
          - /app/extra/max/bin/max "$@"
      - type: file
        path: ru.max.MAX.desktop
      - type: file
        path: ru.max.MAX.metainfo.xml
      - type: file
        path: MAX.png
